TOPSRCDIR = @WINE_SRC_DIR@
TOPOBJDIR = @WINE_DST_DIR@
SRCDIR    = @srcdir@
VPATH     = @srcdir@
MODULE    = wdbgtest.exe
APPMODE   = -mconsole
IMPORTS   = kernel32
DELAYIMPORTS = user32
EXTRALIBS =


C_SRCS = \
	wdbgtest.c

LEX_SRCS   = token.l
BISON_SRCS = parse.y

@MAKE_PROG_RULES@
parse.tab.c: parse.tab.h   # for parallel makes

# Now the rules to build the wdtp program (with various compilation options)
WDTP_SRCS= \
        wdtp.c \
        wdtp_display.c \
        wdtp_execute.c \
        wdtp_expr.c \
        wdtp_stack.c \
        wdtp_start.c \
        wdtp_type.c \
        wdtp_xpoint.c

WDTPCFLAGS = $(INCLUDES) $(DEFS) $(DLLFLAGS)

wdtp_gcc_stabspO0.exe$(DLLEXT): $(WDTP_SRCS)
	$(WINEGCC) $(WDTPCFLAGS) -gstabs+ -O0 -B$(TOOLSDIR)/tools/winebuild -mconsole -o $@ $(WDTP_SRCS) -lkernel32

wdtp_gcc_dwarfO0.exe$(DLLEXT): $(WDTP_SRCS)
	$(WINEGCC) $(WDTPCFLAGS) -gdwarf-2 -O0 -B$(TOOLSDIR)/tools/winebuild -mconsole -o $@ $(WDTP_SRCS) -lkernel32

wdtp_gcc_dwarfO2.exe$(DLLEXT): $(WDTP_SRCS)
	$(WINEGCC) $(WDTPCFLAGS) -gdwarf-2 -O2 -B$(TOOLSDIR)/tools/winebuild -mconsole -o $@ $(WDTP_SRCS) -lkernel32

MINGW32 = @MINGW32@
wdtp_mingw32_stabspO0.exe: $(WDTP_SRCS)
	$(MINGW32) $(WDTPCFLAGS) -gstabs+ -O0 -B$(TOOLSDIR)/tools/winebuild -mconsole -o $@ $(WDTP_SRCS) -lkernel32

MSVC_DIR = @MSVC@
WINE = @WINE_DST_DIR@/wine

MSVC_CFLAGS = /I "$(MSVC_DIR)"/include /Zi /MLd
MSVC_LINK   = /link /LIBPATH:"$(MSVC_DIR)"/lib /DEBUG

wdtp_msvc_pdbOd.exe: $(WDTP_SRCS)
	$(WINE)	"$(MSVC_DIR)"/bin/cl.exe $(MSVC_CFLAGS) /Od /Fe$@ $(WDTP_SRCS) $(MSVC_LINK)
	-rm -f $(WDTP_SRCS:%.c=%.obj) $(@:%.exe=%.ilk)

# The rules for running the tests
WDTPS= \
	display.wdtp \
	execute.wdtp \
	expr.wdtp \
	minidump.wdtp \
	stack.wdtp \
	start.wdtp \
	type.wdtp \
	xpoint.wdtp

test_gcc_stabspO0: all wdtp_gcc_stabspO0.exe$(DLLEXT)
	for i in $(WDTPS); do ./wdbgtest.run --condition stabs --flavor gcc_stabspO0.exe$(DLLEXT) $$i; done

test_gcc_dwarfO0: all wdtp_gcc_dwarfO0.exe$(DLLEXT)
	for i in $(WDTPS); do ./wdbgtest.run --condition dwarf --flavor gcc_dwarfO0.exe$(DLLEXT) $$i; done

test_gcc_dwarfO2: all wdtp_gcc_dwarfO2.exe$(DLLEXT)
	for i in $(WDTPS); do ./wdbgtest.run --condition dwarf --flavor gcc_dwarfO2.exe$(DLLEXT) $$i; done

test_mingw32_stabspO0: all wdtp_mingw32_stabspO0.exe
	for i in $(WDTPS); do ./wdbgtest.run --condition stabs --flavor mingw32_stabspO0.exe $$i; done

test_msvc_pdbOd: all wdtp_msvc_pdbOd.exe
	for i in $(WDTPS); do ./wdbgtest.run --condition pdb --flavor msvc_pdbOd.exe $$i; done

test_gcc: test_gcc_stabspO0 test_gcc_dwarfO0 test_gcc_dwarfO2
test_mingw32: test_mingw32_stabspO0
test_msvc: test_msvc_pdbOd

test:: test_gcc test_mingw32 test_msvc

# The rule for uploading the git tree
.PHONY: upload

upload:
	git update-server-info
	ftpsync --user eric.pouech@wanadoo.fr --passfile ~/.perso-passfile .git ftp://perso-ftp.orange.fr/wdtp.git

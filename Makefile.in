TOPSRCDIR = @WINE_SRC_DIR@
TOPOBJDIR = @WINE_DST_DIR@
SRCDIR    = @srcdir@
VPATH     = @srcdir@
MODULE    = wdbgtest.exe
APPMODE   = -mconsole
IMPORTS   = kernel32
DELAYIMPORTS = user32
EXTRALIBS =


C_SRCS = \
	wdbgtest.c

LEX_SRCS   = token.l
BISON_SRCS = parse.y

# Various definitions
CC	     = @CC@
BISON        = @BISON@
FLEX         = @FLEX@
RM	     = rm -f
CFLAGS       = @CFLAGS@
DLLFLAGS     = -D_REENTRANT -fPIC
DLLEXT	     = .so
TARGETFLAGS  = @TARGETFLAGS@
INCLUDES     = -I$(SRCDIR) -I. -I$(TOPSRCDIR)/include -I$(TOPOBJDIR)/include $(EXTRAINCL)
ALLCFLAGS    = $(INCLUDES) $(EXTRACFLAGS) $(DLLFLAGS) $(CFLAGS)
WINEGCC      = $(TOPOBJDIR)/tools/winegcc/winegcc $(TARGETFLAGS) -B$(TOPOBJDIR)/tools/winebuild

#
OBJS = $(C_SRCS:.c=.o) $(BISON_SRCS:.y=.tab.o) $(LEX_SRCS:.l=.yy.o) $(EXTRA_OBJS)

# some simple rules
.SUFFIXES: .h .y .l .tab.c .tab.h .yy.c

.c.o:
	$(CC) -c $(ALLCFLAGS) -o $@ $<

.y.tab.c:
	$(BISON) $(BISONFLAGS) -p $*_ -o $@ $<

.y.tab.h:
	$(BISON) $(BISONFLAGS) -p $*_ -o $*.tab.c -d $<

.l.yy.c:
	$(FLEX) $(LEXFLAGS) -o$@ $<

all: $(MODULE)$(DLLEXT)

$(MODULE).so: $(OBJS) Makefile.in
	$(WINEGCC) $(APPMODE) $(OBJS) -o $@ $(ALL_LIBS) $(DELAYIMPORTS:%=-Wb,-d%)

parse.tab.c: parse.tab.h   # for parallel makes

# Now the various compiler's options to build the wdtp program
WDTP_SRCS= \
        wdtp.c \
        wdtp_display.c \
        wdtp_execute.c \
        wdtp_expr.c \
        wdtp_stack.c \
        wdtp_start.c \
        wdtp_type.c \
        wdtp_xpoint.c

WDTPCFLAGS = $(INCLUDES) $(DEFS) $(DLLFLAGS)

MINGW32 = @MINGW32@

MSVC_DIR = @MSVC@
WINE = @WINE_DST_DIR@/wine

MSVC_CFLAGS = /I "$(MSVC_DIR)"/include /Zi /MLd
MSVC_LINK   = /link /LIBPATH:"$(MSVC_DIR)"/lib /DEBUG

# The rules for running the tests
WDTPS= \
	display.wdtp \
	execute.wdtp \
	expr.wdtp \
	minidump.wdtp \
	stack.wdtp \
	start.wdtp \
	type.wdtp \
	xpoint.wdtp

# This will be generated by configure as the list of wdtp build and test rules
@WDTP_INCLUDE_TESTS@

test::@WDTP_LIST_TESTS@

.PHONY: wdtp
wdtp:@WDTP_LIST_TARGETS@

# Finish cleaning up the mess
clean::
	$(RM) *.o *.exe.so *.tab.[ch] *.yy.c *.exe *.pdb

distclean:: clean
	$(RM) config.* configure.lineno TAGS tags wdbgtest.run
	$(RM) -r autom4te.cache

# The rule for uploading the git tree
.PHONY: upload

upload:
	git update-server-info
	ftpsync --user eric.pouech@wanadoo.fr --passfile ~/.perso-passfile .git ftp://perso-ftp.orange.fr/wdtp.git
